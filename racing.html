<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>SPLIT-SCREEN RACING – РАБОТИ 100%</title>
<style>
    body { margin:0; overflow:hidden; background:#000; font-family:Arial; }
    #start { position:fixed; inset:0; background:#000; color:#0f0; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:60px; text-align:center; z-index:9999; cursor:pointer; }
    #start button { margin-top:50px; padding:30px 100px; font-size:60px; background:#000; color:#0f0; border:5px solid #0f0; border-radius:25px; box-shadow:0 0 50px #0f0; }
    #start button:hover { background:#0f0; color:#000; }
    #hud, #timer, #divider { opacity:0; transition:opacity 2s; }
    #hud.show, #timer.show, #divider.show { opacity:1; }
    #hud { position:absolute; top:20px; left:20px; color:#0f0; font:bold 40px Courier; text-shadow:0 0 20px #0f0; z-index:100; }
    #timer { position:absolute; top:20px; right:20px; color:#0f0; font:bold 40px Courier; text-shadow:0 0 20px #0f0; z-index:100; }
    #divider { position:absolute; left:0; top:50%; width:100%; height:10px; background:#0f0; box-shadow:0 0 40px #0f0; transform:translateY(-50%); z-index:99; }
</style>
</head>
<body>

<div id="start">
    <div>SPLIT-SCREEN</div>
    <div style="font-size:50px;margin:30px">RACING</div>
    <button>СТАРТ</button>
</div>

<div id="hud">
    P1: <span id="s1">0</span> km/h<br>
    P2: <span id="s2">0</span> km/h
</div>
<div id="timer">00:00.00</div>
<div id="divider"></div>
<canvas id="c"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
<script>
// БЕЗ import – работи навсякъде!
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio(devicePixelRatio));
renderer.shadowMap.enabled = true;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
scene.fog = new THREE.FogExp2(0x87ceeb, 0.0004);

const sun = new THREE.DirectionalLight(0xffffff, 3);
sun.position.set(50,100,50);
sun.castShadow = true;
scene.add(sun);
scene.add(new THREE.AmbientLight(0x404040));

const roadGroup = new THREE.Group();
scene.add(roadGroup);
const SEG = 50;
for(let i=0;i<200;i++){
    const m = new THREE.Mesh(
        new THREE.PlaneGeometry(30,SEG),
        new THREE.MeshLambertMaterial({color:0x333333})
    );
    m.rotation.x = -Math.PI/2;
    m.position.z = i*SEG;
    m.receiveShadow = true;
    roadGroup.add(m);
}

function createCar(color){
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(3,1.8,7), new THREE.MeshLambertMaterial({color}));
    body.position.y = 1.5; body.castShadow = true; g.add(body);
    const roof = new THREE.Mesh(new THREE.BoxGeometry(2.6,1.2,4), new THREE.MeshLambertMaterial({color:color*0.8}));
    roof.position.y = 2.6; g.add(roof);
    return g;
}
const car1 = createCar(0xff0033);
const car2 = createCar(0x0066ff);
scene.add(car1, car2);

const p1 = {x:-5, speed:0, z:0};
const p2 = {x:5, speed:0, z:0};

const cam1 = new THREE.PerspectiveCamera(70,2,0.1,10000);
const cam2 = new THREE.PerspectiveCamera(70,2,0.1,10000);

const keys = {};
let started = false;
let startTime = 0;

document.querySelector('#start button').onclick = () => {
    document.getElementById('start').style.display = 'none';
    document.getElementById('hud').classList.add('show');
    document.getElementById('timer').classList.add('show');
    document.getElementById('divider').classList.add('show');
    started = true;
    startTime = performance.now();
};

addEventListener('keydown', e => keys[e.key.toLowerCase()]=true);
addEventListener('keyup', e => keys[e.key.toLowerCase()]=false);

setInterval(() => {
    if(!started) return;
    const t = (performance.now()-startTime)/1000;
    document.getElementById('timer').textContent = 
        `${String(Math.floor(t/60)).padStart(2,'0')}:${(t%60).toFixed(2).padStart(5,'0')}`;
}, 50);

function loop(){
    if(!started){ requestAnimationFrame(loop); return; }

    // контроли
    if(keys['a']) p1.x -= 0.5;
    if(keys['d']) p1.x += 0.5;
    if(keys['w']) p1.speed += 3;
    if(keys['arrowleft']) p2.x -= 0.5;
    if(keys['arrowright']) p2.x += 0.5;
    if(keys['arrowup']) p2.speed += 3;

    p1.speed *= 0.96; p2.speed *= 0.96;
    p1.z += p1.speed*0.1; p2.z += p2.speed*0.1;

    car1.position.set(p1.x, 1.5, -p1.z);
    car2.position.set(p2.x, 1.5, -p2.z);

    roadGroup.position.z = -(p1.z+p2.z)/2 % SEG;

    cam1.position.set(0,20,-p1.z+50); cam1.lookAt(0,0,-p1.z-50);
    cam2.position.set(0,20,-p2.z+50); cam2.lookAt(0,0,-p2.z-50);

    document.getElementById('s1').textContent = Math.round(p1.speed*3.6);
    document.getElementById('s2').textContent = Math.round(p2.speed*3.6);

    const h = innerHeight/2;
    renderer.setScissorTest(true);
    renderer.setViewport(0,h,innerWidth,h); renderer.render(scene,cam1);
    renderer.setViewport(0,0,innerWidth,h); renderer.render(scene,cam2);

    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>